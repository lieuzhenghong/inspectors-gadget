<!DOCTYPE html>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<link rel='stylesheet' href='./src/style.css'>
<script src="lib/lodash.js"></script>
<script type='text/javascript'>
  let BUILDING = '';
  let FLOOR = '';
  let KEYS = [];
  let labels = [];
  let CLICKED_X = 0;
  let CLICKED_Y = 0;
  let IMAGE = null;
  let ID = 1;
  let canvas = null;
  let ctx = null;
  class Label {
    constructor(id, x, y, title, defect, image){
      this.id = id,
      this.x = x,
      this.y = y,
      this.title = title,
      this.defect = defect,
      this.image = image
    }

    toggle_defect() {
      console.log(this);
      this.defect = (this.defect + 1) % 3;
      console.log(this.defect);
      draw_labels(labels);
    }
  }

  function init() {
    // Set canvas dimensions
    canvas = document.getElementById('c');
    //canvas.width = (document.documentElement.clientWidth);
    //canvas.height = document.documentElement.clientHeight;
    canvas.width = 800;
    canvas.height = 600;
    document.getElementById('c').addEventListener('click', onClick
    , false); 
    var img = new Image();
    img.src = './assets/canvas_placeholder.png';
    IMG = img;
    ctx = document.getElementById('c').getContext('2d');
    ctx.drawImage(img, 0, 0);
    window.onkeyup = (e) => { KEYS[e.keyCode] = false;}
    window.onkeydown = (e) => { KEYS[e.keyCode] = true;}
  }

  function batch_upload(file_list) {
    // FileList has no method map nor forEach
    for (let i = 0; i < file_list.length; i++) {
      labels.push(new Label(ID,
                            null,
                            null, 
                            BUILDING + FLOOR + '-' + (ID).toString(),
                            0,
                            file_list[i]
      ));
      ID++;
    }
    draw_labels(labels);
    draw_table(labels);
  }

  function handletagImg(files) {
    var label = new Label(ID, CLICKED_X, CLICKED_Y,
                          window.prompt('Enter label title:'),
                          0,
                          files[0]
                          );
    ID++;
    labels.push(label);
    draw_labels(labels);
    add_row(label);
  }

  function draw_labels(labels) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(IMG, 0, 0);
    labels.map( (label) => {
      if (label.x !== null && label.y !== null) {
        ctx.textAlign = 'center';
        var wid = ctx.measureText(label.title).width;
        if (label.defect === 0) {
          ctx.fillStyle = 'rgba(0, 200, 0, 0.8)';
        }
        else if (label.defect === 1) {
          ctx.fillStyle = 'rgba(255, 200, 0, 0.9)';
        }
        else {
          ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
        }
        ctx.fillRect(label.x-(wid+10)/2, label.y-(20/2), (wid+10 > 40? wid+10 : 40), 20);
        ctx.strokeRect(label.x-(wid+10)/2, label.y-(20/2), (wid+10 > 40? wid+10 : 40), 20);
        ctx.fillStyle = 'rgba(0, 0, 0, 1)';
        ctx.font = '12px sans-serif';
        ctx.textBaseline = 'middle';
        ctx.fillText(label.title, label.x, label.y);
      }
    });
  }

  function add_row(label) {
    const table = document.getElementById('tag-tables');
    var tbody = document.querySelector('tbody');
    insert_row(label, tbody)
  }

  function toggle_defect(e) {
    console.log(e);
  }

  function insert_row(label, tbody){
    var row = tbody.insertRow();
    row.id = label.id;
    var c0 = row.insertCell(0);
    var c1 = row.insertCell(1);
    var c2 = row.insertCell(2);
    var c3 = row.insertCell(3);
    var c4 = row.insertCell(4);
    c1.addEventListener('click', edit_name);
    c2.addEventListener('mouseover', (e) => {
      return(preview_image(e.target.closest('tr').id))
    });
    c0.innerHTML = label.id;
    c1.innerHTML = "<span class='editable'>" + label.title + "</span>";
    c2.innerHTML = label.image.name;
    c3.innerHTML = '<img src="./assets/green_heart.png" height="32px">';
    var img = c3.querySelector('img');
    img.addEventListener('click', () => {
      console.log('hello');
      label.toggle_defect();
      if (label.defect == 0) {
        img.src = './assets/green_heart.png';
      }
      else if (label.defect == 1) {
        img.src = './assets/yellow_diam.png';
      }
      else {
        img.src = './assets/red_exclam.png';
      }
    });
    c4.innerHTML = '<a onclick="delete_row(' + label.id + ')">X</a>'
  }

  function draw_table(labels){
    const table = document.getElementById('tag-tables');
    const old_tbody = document.querySelector('tbody');
    var tbody = document.createElement('tbody');
    labels.map((label) => {
      return insert_row(label, tbody);
    });
    old_tbody.parentNode.replaceChild(tbody, old_tbody)
  }
  
  function edit_name(e) {
    var val = window.prompt('Edit name:');
    if (val !== '') {
      // this is vert fragile code
      const id = e.target.closest('tr').id;
      console.log('id: ', id);
      var label = _.find(labels, ['id', parseInt(id)]);
      console.log(label);
      label.title = val;
      // Need a smart way to re-draw image and table performantly
      draw_labels(labels);
      draw_table(labels);
    }
  }

  function delete_row(id) {
    //const id = e.target.parentElement.firstChild.textContent;
    console.log(labels)
     _.remove(labels, ['id', parseInt(id)]);
    console.log(labels)
    draw_labels(labels);
    draw_table(labels);
  }

  function onClick(evt) {
    CLICKED_X = evt.x;
    CLICKED_Y = evt.y;
    // If Shift key is held down, go to tag-editing mode
    if (KEYS[16]) {
      var id = window.prompt('Enter id of label: ');
      label = _.find(labels, ['id', parseInt(id)]);
      if (label === undefined) {
        window.alert('Bad ID.');
      }
      else {
        label.x = CLICKED_X;
        label.y = CLICKED_Y;
        // Redraw
        draw_labels(labels);
      }
    }
    else {
      // Upload an image
      document.getElementById('image-tag').click();
    }
  }

  function get_plan(file_list) {
    var plan_img = file_list[0];
    var ctx = document.getElementById('c').getContext('2d');
    var img = new Image();
    img.onload = () => {
      IMG = img;
      draw_labels(labels);
      BUILDING = window.prompt('Enter building letter (e.g. A)');
      FLOOR = window.prompt('Enter building floor (e.g. 1)');
    }
    img.src = URL.createObjectURL(plan_img);
  }

  function export_image(e) {
    console.log(e.href);
    const canvas = document.getElementById("c");
    var image = canvas.toDataURL("image/png");
    e.href = image;
  }

  function preview_image(id) {
    function load_placeholder(e){
      e.target.src = './assets/placeholder.png';
    }
    var file = _.find(labels, ['id', parseInt(id)]).image;
    var img = document.getElementById('img-preview');
    img.addEventListener('error', load_placeholder);
    var reader = new FileReader();
    reader.addEventListener("load", function () {
      img.src = reader.result;
    }, false);
    reader.readAsDataURL(file);
  }
</script>
<body onload='init()'>
<div class = 'wrapper'>
<div class='col1'>
  <canvas id = 'c'>
  </canvas>
  <div class = 'button-wrapper'>
    <input class='button' type='file' id='plan-upload' accept='image/*'
    onchange='get_plan(this.files)' capture='camera'>
    <label for='plan-upload'>Upload plan</label>
    <input class='button' type='file' id='batch-upload' accept='image/*'
    multiple onChange='batch_upload(this.files)'>
    <label for='batch-upload'>Batch import</label>
    <a class='label' onclick="export_image(this)" href="#"
    target="_blank">Export plan</a> <input class='button' type='file'
    id='image-tag' accept='image/*' onChange='handletagImg(this.files)'>
  </div>
</div>
<div class='col2'>
  <div class = 'table-wrapper'>
  <table id = 'tag-tables'>
    <tbody>
    </tbody>
  </table>
  </div>
<img id='img-preview' src="./assets/placeholder.png" height="300" width="300">
</div>
</div>

